{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/uiDefinition.json#",
  "handler": "Microsoft.Resources.CreateUiDefinition",
  "version": "1.0.0",
  "parameters": {
    "basics": [
      {
        "name": "workspaceName",
        "type": "Microsoft.Common.TextBox",
        "label": "Log Analytics Workspace Name",
        "toolTip": "Enter the name of your existing Log Analytics workspace.",
        "placeholder": "Enter workspace name",
        "constraints": {
          "required": true,
          "regex": "^[a-zA-Z0-9][a-zA-Z0-9-]{2,62}$",
          "validationMessage": "Workspace name must be 3-63 characters long and can contain letters, numbers, and hyphens."
        }
      },
      {
        "name": "workspaceResourceGroup",
        "type": "Microsoft.Common.DropDown",
        "label": "Workspace Resource Group",
        "toolTip": "Select the resource group that contains your Log Analytics workspace.",
        "constraints": {
          "required": true,
          "allowedValues": "[map(resourceGroups(), (item) => parse(concat('{\"label\":\"', item.name, '\",\"value\":\"', item.name, '\"}')))]"
        }
      }
    ],
    "steps": [
      {
        "name": "selectLogs",
        "label": "Select Log Sources to Deploy",
        "elements": [
          {
            "name": "logSourceCategory",
            "type": "Microsoft.Common.DropDown",
            "label": "Log Source Category",
            "toolTip": "Select the category of log sources you want to configure.",
            "defaultValue": "All Categories",
            "constraints": {
              "required": true,
              "allowedValues": [
                {
                  "label": "All Categories",
                  "value": "all"
                },
                {
                  "label": "Platform & Health",
                  "value": "platform"
                },
                {
                  "label": "Microsoft 365",
                  "value": "office365"
                },
                {
                  "label": "Security Alerts",
                  "value": "security"
                },
                {
                  "label": "Microsoft Defender XDR",
                  "value": "xdr"
                }
              ]
            }
          },
          {
            "name": "platformLogSources",
            "type": "Microsoft.Common.CheckBoxGroup",
            "label": "Platform & Health Log Sources",
            "toolTip": "Select core platform and health monitoring sources.",
            "visible": "[or(equals(steps('selectLogs').logSourceCategory, 'all'), equals(steps('selectLogs').logSourceCategory, 'platform'))]",
            "options": {
              "items": [
                { 
                  "label": "Azure Activity (Platform Logs)", 
                  "value": "AzureActivity" 
                },
                { 
                  "label": "Sentinel Health (Automatic)", 
                  "value": "SentinelHealth" 
                },
                {
                  "label": "Azure Resource Health",
                  "value": "ResourceHealth"
                },
                {
                  "label": "Azure Service Health",
                  "value": "ServiceHealth"
                }
              ]
            }
          },
          {
            "name": "officeLogSources",
            "type": "Microsoft.Common.CheckBoxGroup",
            "label": "Microsoft 365 Activity Log Sources",
            "toolTip": "Select Microsoft 365 and Office activity logging sources.",
            "visible": "[or(equals(steps('selectLogs').logSourceCategory, 'all'), equals(steps('selectLogs').logSourceCategory, 'office365'))]",
            "options": {
              "items": [
                { 
                  "label": "Office Activity (Exchange, SharePoint, Teams)", 
                  "value": "Office365" 
                },
                {
                  "label": "Azure Active Directory Audit Logs",
                  "value": "AADAuditLogs"
                },
                {
                  "label": "Azure Active Directory Sign-in Logs",
                  "value": "AADSignInLogs"
                },
                {
                  "label": "Azure Active Directory Non-Interactive User Sign-in Logs",
                  "value": "AADNonInteractiveUserSignInLogs"
                }
              ]
            }
          },
          {
            "name": "securityAlertSources",
            "type": "Microsoft.Common.CheckBoxGroup",
            "label": "Security Alert Sources",
            "toolTip": "Select Microsoft security alert sources to deploy.",
            "visible": "[or(equals(steps('selectLogs').logSourceCategory, 'all'), equals(steps('selectLogs').logSourceCategory, 'security'))]",
            "options": {
              "items": [
                { 
                  "label": "Security Alert (Entra ID Protection - IPC)", 
                  "value": "EntraIDProtection" 
                },
                { 
                  "label": "Security Alert (Defender for Endpoint - MDATP)", 
                  "value": "DefenderEndpoint" 
                },
                { 
                  "label": "Security Alert (Defender for Identity - AATP)", 
                  "value": "DefenderIdentity" 
                },
                { 
                  "label": "Security Alert (Defender for Cloud Apps - MCAS)", 
                  "value": "DefenderCloudApps" 
                },
                { 
                  "label": "Security Alert (Defender for Cloud)", 
                  "value": "DefenderCloud" 
                },
                { 
                  "label": "Security Alert (Defender for IoT)", 
                  "value": "DefenderIoT" 
                },
                {
                  "label": "Microsoft Cloud App Security (MCAS)",
                  "value": "MCAS"
                },
                {
                  "label": "Azure Security Center",
                  "value": "SecurityCenter"
                }
              ]
            }
          },
          {
            "name": "xdrSources",
            "type": "Microsoft.Common.CheckBoxGroup",
            "label": "Microsoft Defender XDR Sources",
            "toolTip": "Select Microsoft Defender XDR incident and alert sources.",
            "visible": "[or(equals(steps('selectLogs').logSourceCategory, 'all'), equals(steps('selectLogs').logSourceCategory, 'xdr'))]",
            "options": {
              "items": [
                { 
                  "label": "Security Incident (Microsoft Defender XDR)", 
                  "value": "DefenderXDRIncidents" 
                },
                { 
                  "label": "Security Alert (Microsoft Defender XDR)", 
                  "value": "DefenderXDRAlerts" 
                },
                {
                  "label": "Microsoft Defender XDR Advanced Hunting",
                  "value": "DefenderXDRAdvancedHunting"
                },
                {
                  "label": "Microsoft Defender XDR Email Events",
                  "value": "DefenderXDREmailEvents"
                }
              ]
            }
          },
          {
            "name": "deploymentValidation",
            "type": "Microsoft.Common.InfoBox",
            "options": {
              "icon": "Info",
              "text": "Please select at least one log source to deploy. Use the dropdown above to filter categories, then select specific sources using the checkboxes. The selected solutions will be installed in your Microsoft Sentinel workspace to enable data ingestion and analytics."
            }
          }
        ]
      },
      {
        "name": "reviewSelection",
        "label": "Review & Confirm",
        "elements": [
          {
            "name": "deploymentSummary",
            "type": "Microsoft.Common.Section",
            "label": "Deployment Summary",
            "elements": [
              {
                "name": "workspaceInfo",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "[concat('Target Workspace: ', basics('workspaceName'), ' (Resource Group: ', basics('workspaceResourceGroup'), ')')]"
                }
              },
              {
                "name": "selectedCategory",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "[concat('Selected Category: ', steps('selectLogs').logSourceCategory)]"
                }
              },
              {
                "name": "selectedSourcesCount",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "[concat('Total Log Sources Selected: ', string(add(add(add(length(coalesce(steps('selectLogs').platformLogSources, createArray())), length(coalesce(steps('selectLogs').officeLogSources, createArray()))), length(coalesce(steps('selectLogs').securityAlertSources, createArray()))), length(coalesce(steps('selectLogs').xdrSources, createArray())))))]"
                }
              },
              {
                "name": "selectedSourcesList",
                "type": "Microsoft.Common.TextBlock",
                "options": {
                  "text": "[concat('Selected Sources: ', string(union(union(union(coalesce(steps('selectLogs').platformLogSources, createArray()), coalesce(steps('selectLogs').officeLogSources, createArray())), coalesce(steps('selectLogs').securityAlertSources, createArray())), coalesce(steps('selectLogs').xdrSources, createArray()))))]"
                }
              }
            ]
          }
        ]
      }
    ],
    "outputs": {
      "workspaceName": "[basics('workspaceName')]",
      "workspaceResourceGroup": "[basics('workspaceResourceGroup')]",
      "selectedCategory": "[steps('selectLogs').logSourceCategory]",
      "logSources": "[union(union(union(coalesce(steps('selectLogs').platformLogSources, createArray()), coalesce(steps('selectLogs').officeLogSources, createArray())), coalesce(steps('selectLogs').securityAlertSources, createArray())), coalesce(steps('selectLogs').xdrSources, createArray()))]",
      "platformLogSources": "[coalesce(steps('selectLogs').platformLogSources, createArray())]",
      "officeLogSources": "[coalesce(steps('selectLogs').officeLogSources, createArray())]",
      "securityAlertSources": "[coalesce(steps('selectLogs').securityAlertSources, createArray())]",
      "xdrSources": "[coalesce(steps('selectLogs').xdrSources, createArray())]"
    }
  }
}
